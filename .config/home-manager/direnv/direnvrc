# vim: ft=bash

# Override use_flake to inject a helper variable for prompts
# https://stackoverflow.com/a/1369211/14436105
eval "$(echo "orig_use_flake()"; declare -f use_flake | tail -n +2)"
function use_flake() {
    export DIRENV_USED="flake:${1:-$(basename "$PWD")}"
    orig_use_flake "$@";
}

# Convenience variable for generic prompt awareness
export DIRENV_USED="direnv"

# Helper to load extra flakes or nixpkgs into the environment (as if by `nix shell`).
use_pkgs() {
    pkgs=()
    args=()
    for arg in "$@"; do
        case "$arg" in
            *#* | *:*)
                pkgs+=("$arg")
                ;;
            -*)
                args+=("$arg")
                ;;
            *)
                pkgs+=("nixpkgs#$arg")
                ;;
        esac
    done
    direnv_load nix shell \
        --override-input nixpkgs flake:nixpkgs \
        "${args[@]}" "${pkgs[@]}" \
        --command "$direnv" dump
}

# TODO: some kind of fish exportable function helper would be nice, little bash cmds
# with `lib.mapAttrsToList pkgs.writeShellScriptBin` seems easier for the time being
